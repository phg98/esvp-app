<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ESVP 투표</title>
    <link rel="manifest" href="/manifest.json">
    <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
    <link rel="manifest" href="/site.webmanifest">
    <link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5">
    <meta name="msapplication-TileColor" content="#da532c">
    <meta name="theme-color" content="#ffffff">
    <!-- Bootstrap CSS -->
    <link href="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css" rel="stylesheet">
    <style>
        #resultsList {
            list-style-type: none; /* 불릿 포인트 제거 */
            padding-left: 0; /* 패딩 제거 */
        }
    </style>
    
</head>

<body class="bg-light py-3">

    <div class="container">
        <div class="card">
            <div class="card-body">
                <h2 class="card-title text-center">오늘 회의는...</h2>
                <div class="d-flex justify-content-center my-2">
                    <select id="esvpVote" class="custom-select w-50 mx-auto">
                        <option value="Explorer">Explorer  - 적극적으로 참여하겠다</option>
                        <option value="Shopper">Shopper   - 괜찮은 것이 있기를 기대한다</option>
                        <option value="Vacationer">Vacationer- 편하게 쉬다 가겠다</option>
                        <option value="Prisoner">Prisoner  - 참석을 원하지 않지만, 어쩔 수 없이 참석했다</option>
                    </select>
                </div>                
                <div class="text-center my-2">
                    <button onclick="submitVote()" class="btn btn-primary">투표하기</button>
                </div>
            </div>
        </div>

        <div class="card my-2">
            <div class="card-body">
                <h2 class="card-title text-center">투표 결과</h2>
                <ul id="resultsList" class="list-group list-group-flush mx-auto text-center w-50">
                    <!-- 결과 동적 삽입 위치 -->
                </ul>
                <div class="text-center my-2">
                    <button onclick="fetchResults()" class="btn btn-info">결과 새로고침</button>
                </div>

                <div class="text-center my-2">
                    <button onclick="resetVotes()" class="btn btn-danger">투표 초기화</button>
                </div>
            </div>
        </div>
    </div>
                    
    <!-- 카카오광고 -->
    <style>
        .kakao-ad {
            margin-top: 10px;  /* 위쪽 간격 20픽셀 추가 */
            max-width: 300px;  /* 폭을 300픽셀로 제한 */
            margin-left: auto;  /* 가운데 정렬을 위한 스타일 */
            margin-right: auto; /* 가운데 정렬을 위한 스타일 */
        }
    </style>
    <!--
    <div class="kakao-ad">
            <ins class="kakao_ad_area" style="display:none;"
            data-ad-unit = "DAN-YZg1Xm59qe77SxKs"
            data-ad-width = "320"
            data-ad-height = "100"></ins>
            <script type="text/javascript" src="//t1.daumcdn.net/kas/static/ba.min.js" async></script>
    </div>
    -->
    <div class="kakao-ad">
        <ins class="kakao_ad_area" style="display:none;"
            data-ad-unit = "DAN-CVhdbZa5Vn7GXCSt"
            data-ad-width = "300"
            data-ad-height = "250">
        </ins>
        <script type="text/javascript" src="//t1.daumcdn.net/kas/static/ba.min.js" async></script>
    </div>

    <!-- Buy Me a Coffee 버튼 -->
    <style>
        .buymeacoffee {
            margin-top: 10px;  /* 위쪽 간격 20픽셀 추가 */
            margin-bottom: 10px;
            max-width: 300px;  /* 폭을 300픽셀로 제한 */
            margin-left: auto;  /* 가운데 정렬을 위한 스타일 */
            margin-right: auto; /* 가운데 정렬을 위한 스타일 */
        }
    </style>
    <div class="buymeacoffee mt-3 text-center">
            <script type="text/javascript" src="https://cdnjs.buymeacoffee.com/1.0.0/button.prod.min.js" 
                data-name="bmc-button" data-slug="phg9898b" 
                data-color="#FFDD00" data-emoji=""  data-font="Cookie" data-text="Buy me a coffee" 
                data-outline-color="#000000" data-font-color="#000000" data-coffee-color="#ffffff" >
            </script>
    </a>

    <!-- Bootstrap JS, Popper.js, and jQuery -->
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.16.0/umd/popper.min.js"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>

    <script>
        // PWA 설정
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('/service-worker.js').then(() => {
                console.log('Service Worker registered successfully.');
            }).catch((error) => {
                console.log('Service Worker registration failed:', error);
            });
        }

        const SERVER_URL = 'https://esvp-app.phg98.workers.dev/';

        async function submitVote() {
            const selectedVote = document.getElementById('esvpVote').value;
            const response = await fetch(`${SERVER_URL}vote`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ vote: selectedVote })
            });

            if (response.ok) {
                fetchResults();
            } else {
                alert('투표 중 오류가 발생했습니다.');
            }
        }

        async function fetchResults() {
            const response = await fetch(`${SERVER_URL}results`);
            const results = await response.json();
            const resultsList = document.getElementById('resultsList');
            resultsList.innerHTML = '';  // 결과 목록 초기화

            for (const [key, value] of Object.entries(results)) {
                const listItem = document.createElement('li');
                listItem.textContent = key + ": " + value + "표";
                resultsList.appendChild(listItem);
            }
        }

        async function resetVotes() {
            const response = await fetch(`${SERVER_URL}reset`);
            if (response.ok) {
                alert('투표가 초기화되었습니다.');
                fetchResults();
            } else {
                alert('투표 초기화 중 오류가 발생했습니다.');
            }
        }
        // 페이지 로딩시 결과를 가져옵니다.
        window.onload = fetchResults;
    </script>
</body>

</html>
